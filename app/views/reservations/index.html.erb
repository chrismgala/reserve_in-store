
<% content_for(:title) { 'Reservations' } %>

<div class="Polaris-Card reservation-search-bar">
  <div class="Polaris-Stack">
    <div class="Polaris-Stack__Item Polaris-Stack__Item--fill">
      <%= render partial: 'reservation_search_form', locals: { reservation: @reservations } %>
    </div>
    <div class="Polaris-Stack__Item add-new-reservation-btn-container">
      <button type="button" class="Polaris-Button Polaris-Button--primary reservation-modal-show add-new-reservation-btn">
        <span class="Polaris-Button__Content"><span>Add New Reservation</span></span></button>
    </div>
  </div>
</div>

<div class="Polaris-Page reservation-page">
  <div class="Polaris-Page__Content">
    <% if @reservations.any? %>
      <div class="Polaris-Card">
        <div class="">
          <div class="Polaris-DataTable Polaris-DataTable--hasFooter">
            <div class="Polaris-DataTable__ScrollContainer">
              <table class="Polaris-DataTable__Table">
                <thead>
                <tr>
                  <th class="Polaris-DataTable__Cell Polaris-DataTable__Cell--fixed Polaris-DataTable__Cell--header Polaris-DataTable__Cell--sortable" scope="col" aria-disabled="true">
                    <%= sortable('id', '#') %>
                  </th>
                  <th aria-hidden="true" role="presentation" class="Polaris-DataTable__Cell Polaris-DataTable__Cell--presentational Polaris-DataTable__Cell--header"></th>
                  <th class="Polaris-DataTable__Cell Polaris-DataTable__Cell--header Polaris-DataTable__Cell--text Polaris-DataTable__Cell--sortable" scope="col" aria-disabled="true">
                    <%= sortable('created_at', 'Placed At') %>
                  </th>
                  <th class="Polaris-DataTable__Cell Polaris-DataTable__Cell--header Polaris-DataTable__Cell--text" scope="col" aria-disabled="true">
                    Customer
                  </th>
                  <th class="Polaris-DataTable__Cell Polaris-DataTable__Cell--header Polaris-DataTable__Cell--text" scope="col" aria-disabled="true">
                    Pickup Time/Date
                  </th>
                  <th class="Polaris-DataTable__Cell Polaris-DataTable__Cell--header Polaris-DataTable__Cell--text Polaris-DataTable__Cell--sortable" scope="col" aria-disabled="true">
                    <%= sortable('location_id', 'Pickup Location') %>
                  </th>
                  <th class="Polaris-DataTable__Cell Polaris-DataTable__Cell--header Polaris-DataTable__Cell--text" scope="col" aria-disabled="true">
                    Order
                  </th>
                  <th class="Polaris-DataTable__Cell Polaris-DataTable__Cell--header Polaris-DataTable__Cell--text Polaris-DataTable__Cell--sortable" scope="col" aria-disabled="true">
                    <%= sortable('fulfilled', 'Status') %>
                  </th>
                  <th class="Polaris-DataTable__Cell Polaris-DataTable__Cell--header Polaris-DataTable__Cell--text Polaris-DataTable__Cell--sortable" scope="col" aria-disabled="true">

                  </th>
                </tr>
                </thead>
                <tbody>
                <% @products = related_products(@reservations) %>
                <% @reservations.includes(:location).each do |reservation| %>
                  <tr class="Polaris-DataTable__TableRow">
                    <th class="Polaris-DataTable__Cell Polaris-DataTable__Cell--fixed Polaris-DataTable__Cell--text" scope="row">
                      <p class="polaris-header-text"><%= reservation.id %></p></th>
                    <td aria-hidden="true" role="presentation" class="Polaris-DataTable__Cell Polaris-DataTable__Cell--presentational"></td>

                    <td class="Polaris-DataTable__Cell Polaris-DataTable__Cell--text">
                      <p class="polaris-header-text"><%= local_time_ago(reservation.created_at) %></p>
                    </td>
                    <td class="Polaris-DataTable__Cell Polaris-DataTable__Cell--text">
                      <%= reservation.customer_name %>
                      <br><%= reservation.customer_email %><br><%= reservation.customer_phone %>
                    </td>
                    <td class="Polaris-DataTable__Cell Polaris-DataTable__Cell--text">
                      <% if reservation.instructions_from_customer.present? || reservation.additional_fields.present? %>
                        <div>
                          <%= reservation.instructions_from_customer if reservation.instructions_from_customer.present? %>
                          <% if reservation.additional_fields.present? %>
                            <div>
                              <a href="#" class="Polaris-Link more-info-<%= reservation.id %>-toggle" onclick="$('.more-info-<%= reservation.id %>-toggle').toggle(); return false;">
                                Show more details
                              </a>
                              <div class="more-info-<%= reservation.id %>-toggle" style="display: none;">
                                <% reservation.additional_fields.each do |additional_fields_key, additional_fields_value| %>
                                  <p><%= additional_fields_key %> : <%= additional_fields_value %></p>
                                <% end %>
                              </div>
                              <a href="#" class="Polaris-Link more-info-<%= reservation.id %>-toggle" onclick="$('.more-info-<%= reservation.id %>-toggle').toggle(); return false;" style="display: none;">
                                Hide
                              </a>
                            </div>
                          <% end %>
                        </div>
                      <% end %>
                    </td>
                    <td class="Polaris-DataTable__Cell Polaris-DataTable__Cell--text">
                      <%= reservation.location.name %>
                    </td>
                    <td class="Polaris-DataTable__Cell Polaris-DataTable__Cell--text">

                      <% reservation.cart[:items].to_a.each do |item| %>
                        <div class="reserved-cart-items">
                          <%= truncate(item[:product_title], length: 30, separator: '...') %>
                          <% if item[:variant_title].present? && item[:variant_title] != 'Default Title' %>
                            <div class="ris-text-small">
                              Variant: <%= item[:variant_title] %>
                            </div>
                          <% end %>
                        </div>
                      <% end %>
                      <div>
                        <a href="#" class="Polaris-Link" onclick="$('.reservationItems-<%= reservation.id %>').show(); return false;">
                          View Item details
                        </a>
                      </div>
                      <%= render partial: 'reserved_items_modal', locals: { store: @current_store, reservation: reservation } %>
                    </td>

                    <td class="Polaris-DataTable__Cell Polaris-DataTable__Cell--text datatable-cell-small-width">
                      <% if reservation.platform_order_id %>
                        <p>
                          <a href="https://<%= @current_store.shopify_domain %>/admin/orders/<%= reservation.platform_order_id %>" title="Paid via Order #<%= reservation.platform_order_id %>" class="Polaris-Link" target="_blank">
                            <span>
                              <span class="Polaris-Badge Polaris-Badge--statusSuccess">Paid</span>
                            </span>
                          </a>
                        </p>
                      <% end %>

                      <% if reservation.fulfilled? %>
                        <span><span class="Polaris-Badge Polaris-Badge--statusSuccess">Fulfilled</span></span>
                      <% else %>
                        <% if reservation.is_unfulfilled? %>
                          <span><span class="Polaris-Badge Polaris-Badge--progressIncomplete">Unfulfilled</span></span>
                        <% end %>
                      <% end %>
                    </td>

                    <td class="Polaris-DataTable__Cell Polaris-DataTable__Cell--text datatable-cell-small-width cta-col" >

                      <% if !reservation.fulfilled? && !reservation.is_unfulfilled?  %>
                        <%= form_with(model: reservation, url: reservation_path(reservation), html: { class: 'reservation-status-form' }, method: :put) do |f| %>
                          <%= f.hidden_field :fulfilled, value: true %>
                          <button type="submit" class="Polaris-Button Polaris-Button--primary Polaris-Button--sizeSlim reservation-fulfill-btn" title="Fulfill Reservation">
                            <span class="Polaris-Icon">
                              <svg class="Polaris-Icon__Svg reservation-fulfill-svg" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path d="M18 16.5a1.5 1.5 0 01-1.5 1.5h-13A1.5 1.5 0 012 16.5V9h2v4h2.382c.379 0 .725.214.894.553L8 15h4l.724-1.447a.998.998 0 01.894-.553H16V9h2v7.5z" fill="#5C5F62"/><path d="M8.293 8.707l-3-3a.999.999 0 111.414-1.414L9 6.586l4.293-4.293a.999.999 0 111.414 1.414l-5 5a.997.997 0 01-1.414 0z" fill="#5C5F62"/>
                              </svg>
                            </span>
                          </button>
                        <% end %>
                        <% if !reservation.is_unfulfilled? && @current_store.reservation_unfulfilled_send_notification? %>
                          <a href="#" class="Polaris-Button Polaris-Button--primary Polaris-Button--sizeSlim reservation-unFulfill-btn"
                             onclick="$('.unfulfilled-reservation-email-modal-<%= reservation.id %>').show(); return false;"
                             title="UnFulfill Reservation">
                            <span class="Polaris-Icon">
                              <svg  class="Polaris-Icon__Svg reservation-unFulfill-svg" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M3 3v11h3.5c.775 0 1.388.662 1.926 1.244l.11.12c.366.391.886.636 1.464.636s1.098-.245 1.463-.637l.111-.119C12.112 14.662 12.725 14 13.5 14H17V3H3zm3-2H2.5A1.5 1.5 0 001 2.5v15A1.5 1.5 0 002.5 19h15a1.5 1.5 0 001.5-1.5v-15A1.5 1.5 0 0017.5 1H6z" fill="#5C5F62"/>
                              </svg>
                            </span>
                          </a>
                          <%= render partial: 'unfulfilled_reservation_email_modal', locals: { store: @current_store, reservation: reservation } %>
                        <% else %>
                          <%= form_with(model: reservation, url: reservation_path(reservation), html: { class: 'reservation-status-form' }, method: :put) do |f| %>
                            <%= f.hidden_field :is_unfulfilled, value: true %>
                            <button type="submit" class="Polaris-Button Polaris-Button--primary Polaris-Button--sizeSlim reservation-unFulfill-btn" title="UnFulfill Reservation">
                              <span class="Polaris-Icon">
                                <svg  class="Polaris-Icon__Svg reservation-unFulfill-svg" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                  <path fill-rule="evenodd" d="M3 3v11h3.5c.775 0 1.388.662 1.926 1.244l.11.12c.366.391.886.636 1.464.636s1.098-.245 1.463-.637l.111-.119C12.112 14.662 12.725 14 13.5 14H17V3H3zm3-2H2.5A1.5 1.5 0 001 2.5v15A1.5 1.5 0 002.5 19h15a1.5 1.5 0 001.5-1.5v-15A1.5 1.5 0 0017.5 1H6z" fill="#5C5F62"/>
                                </svg>
                              </span>
                            </button>
                          <% end %>
                        <% end %>
                      <% end %>

                      <a class="Polaris-Button Polaris-Button--destructive Polaris-Button--sizeSlim" data-remote="true" data-confirm="Are you sure you want to delete this reservation?" rel="nofollow" data-method="delete" href="<%= reservation_path(reservation.id) %>">
                        <span class="Polaris-Icon">
                          <svg class="Polaris-Icon__Svg" aria-hidden="true" focusable="false" data-prefix="far" data-icon="trash-alt" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg="">
                            <path fill="currentColor" d="M268 416h24a12 12 0 0 0 12-12V188a12 12 0 0 0-12-12h-24a12 12 0 0 0-12 12v216a12 12 0 0 0 12 12zM432 80h-82.41l-34-56.7A48 48 0 0 0 274.41 0H173.59a48 48 0 0 0-41.16 23.3L98.41 80H16A16 16 0 0 0 0 96v16a16 16 0 0 0 16 16h16v336a48 48 0 0 0 48 48h288a48 48 0 0 0 48-48V128h16a16 16 0 0 0 16-16V96a16 16 0 0 0-16-16zM171.84 50.91A6 6 0 0 1 177 48h94a6 6 0 0 1 5.15 2.91L293.61 80H154.39zM368 464H80V128h288zm-212-48h24a12 12 0 0 0 12-12V188a12 12 0 0 0-12-12h-24a12 12 0 0 0-12 12v216a12 12 0 0 0 12 12z">
                            </path>
                          </svg>
                        </span>
                      </a>
                    </td>
                  </tr>
                <% end %>
                </tbody>
                <tfoot class="Polaris-DataTable__TableFoot">
                <tr>
                  <td class="Polaris-DataTable__Cell Polaris-DataTable__Cell--footer">
                    <p>
                      Showing <%= @reservations.count %>
                      of <%= pluralize(@reservations.total_count, 'reservation') %>.
                    </p>
                  </td>
                </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <br>
      <% if @reservations.count < @current_store.reservations.count %>
        <%= render partial: 'layouts/partials/polaris_pagination', locals: {items: @reservations} %>
      <% end %>

    <% else %>
      <div class="Polaris-Stack">
        <div class="Polaris-Stack__Item Polaris-Stack__Item--fill">
          <% if params[:reservation_search] %>
            <p>No reservation found</p>
          <% else %>
            <p>There are no reservations yet.</p>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Modal -->
<%= render partial: 'new_reservation_modal' %>

<% content_for(:javascript) do %>
  <script>
      polarisTableHeaderFix();

      var reservationModal = new PolarisModal({
          triggerSelector: ".reservation-modal-show",
          containerID: "reservation-modal-container",
          formID: "reservationCreateForm",
          closeClass: "reservation-modal-close",
          submitBtnID: "reservation-modal-submit",
          chooseProductsFirst: true
      });
  </script>
<% end %>
